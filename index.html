<!DOCTYPE html>
<html lang="en" >
<head >
    <meta charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1" >
    <title ></title >
    <style type="text/css" >
        @font-face {
            font-family: 'AANeon';
            src: url('data/AA-Neon.ttf') format("truetype");
        }

        html, body, #background, #canvas {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        body {
            background-color: black;
        }

        #background {
            filter: brightness(7.5%);
            background: url("data/background.jpg") no-repeat fixed left top / 100% 100%;
        }

        #assets {
            width: 0px;
            height: 0px;
            overflow: hidden;
        }
    </style >
</head >
<body >
<div id="assets" >
    <span style="font: 48px 'AANeon';" >Text asset initialization</span >
    <canvas id="asset_factory" width="1920" height="1080" ></canvas >
</div >
<audio id="sound" >
    <source type="audio/mp3" src="data/sound.mp3" >
</audio >
<div id="background"></div>
<canvas id="canvas" width="1920" height="1080" ></canvas>
</body >
<script type="text/javascript" src="node_modules/Color/Color.js" ></script >
<script type="text/javascript" src="node_modules/Pixels/Pixels.js" ></script >
<script type="text/javascript" src="node_modules/ConvexText/ConvexText.js" ></script >
<script type="text/javascript" src="soundEffect.js" ></script >
<script type="text/javascript" src="assetFactory.js" ></script >
<script type="text/javascript" src="sparks.js" ></script >
<script type="text/javascript" src="scene.js" ></script >
<script type="text/javascript" >

  // TODO add sparks with light paths for animation

  let animatedImg, staticImg;
  const sound = new SoundEffect('sound', 5, 2);
  const scene = new Scene(null, 24);
  const bgImg = new Image();

  const _animatedText = (cnx, x, y, angle) => {
    cnx.fillStyle = '#F433FF';
    cnx.rotate(angle);
    cnx.font = '220px "AANeon"';
    cnx.fillText("C", x, y);
    cnx.rotate(-angle);
  };

  const _staticText = (cnx, x, y, angle) => {
    cnx.fillStyle = '#F433FF';
    cnx.font = '92px "AANeon"';
    cnx.rotate(angle);
    cnx.fillText("Я_ВСЕГДА_ХОТЕЛ_БЫТЬ", x + 60, y);
    cnx.font = '220px "AANeon"';
    cnx.fillText("  КРИПАЧEМ", x, y + 220);
    cnx.rotate(-angle);
  };

  bgImg.src = 'data/background.jpg';

  let sparks;
  let sparksAnimation;

  bgImg.addEventListener('load', () => {
    let assetFactory;
    assetFactory = new AssetCanvas('asset_factory', bgImg, (context) => {
      _animatedText(context, 182, 720, -(Math.PI / 180) * 10);
    });
    assetFactory.compose().then((image) => {
      animatedImg = image;
      assetFactory.setTextDrawer((context) => {
        _staticText(context, 120, 500, -(Math.PI / 180) * 10);
      });
      assetFactory.compose().then((image) => {
        staticImg = image;
        sparks = new Sparks(canvas.getContext('2d'), 500, 500);
        sparksAnimation = sparks.animate();
        sound.play(true);
      });
    });
  });

  scene.onFrame = (() => {
    const canvas = document.getElementById('canvas');
    const cnx = canvas.getContext('2d');

    return () => {
      if (!sound.playing) return;
      let ratio = sound.currentRatio;
      cnx.clearRect(0, 0, canvas.width, canvas.height);
      // use source-in to make lightened wall
      cnx.filter = 'opacity(' + parseInt(75 + (1 - ratio) * 25 >>> 0) + '%)';
      cnx.drawImage(staticImg, 0, 0);
      //cnx.filter = 'opacity(' + parseInt(ratio * 100 >>> 0) + '%)';
      //cnx.drawImage(animatedImg, 0, 0);
      cnx.filter = 'none';
      if (!sparksAnimation.next().done) {
        scene.invalid();
      }
    };
  })();
  sound.onChange = () => {
    scene.invalid();
  };
</script>
</html >
